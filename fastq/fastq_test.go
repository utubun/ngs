package fastq

import (
	"encoding/json"
	"strings"
	"testing"

	"github.com/utubun/ngs/fastq/internal"
)

const (
	FASTQ = `@ERR101899.1 M10_151:1:2:13999:1320 length=150
ATGATAAGCAAAGCCACATTAGAAAATGTGACTTTGCCAATTTCAGAATGCTTATTGCAAACCGAAATTATTAGAAAGTTGTTGGTCTTGCTCTTGAACGGCATCAGCAGTGCTATTCAATTGTTGTTTAATTTCTTCTAATAATTGTGC
+ERR101899.1 M10_151:1:2:13999:1320 length=150
@@@DDFFDHFHHFFGIJIIIGGIJJJJGHH@BHEIGHGIJJJJGEFGGHI>FGEGHIDGDB?(@BGIEHGGIGCHHHGACEDDDD;>CEEC:ACDDCC:<==B<9::@CDCD:@C>@3@@@CC@CB<BC3:CDDC3>>C@4:C#######
@ERR101899.2 M10_151:1:2:16018:1324 length=150
CGATAAAACCCCAAGCGATGAAAGCGCCAATGTTTGGCATGATCATACTACTTAAGAATGATCCAAATGCTTGAACACGACGACCAATTCCTTTTTTCTCTTCAGTTTGTGACATATTTACACCTCTTTTTTAATATATGTGACTATATA
+ERR101899.2 M10_151:1:2:16018:1324 length=150
@@@FFFFFHFDHHIGAFGEGHJJCGGGJGGIGDFBHEHGIJIDCGHIIDGGGGIJIFIDGBGHHHHHHFFFFFDDECCBBDBDDDDDDDDACDCDDBCDCCDDEACDDCACCCCCDDDEEC>(93?@CCCCBDCDC>@C>>BDA:>CD##
@ERR101899.3 M10_151:1:2:18902:1324 length=150
GAGGTGCAATGATGACTCGTTCTCAGAACAAACAGCAACAATTAGAACAAGCAAAAGATATTGTAATTAATTCAATTGGACAGACAATGGATTTGTATGGCACTAATAGAAGTGTAGGAAACTTATATGGCACTATGGTGTTTGAAGGCA
+ERR101899.3 M10_151:1:2:18902:1324 length=150
@@@DABDDADHBAGBHEGCGGIIEGIIIBFGEGAFGIGEHICHGHHIGGI@DFEHGAF>CGGH@GGAHHGGHDHFCHFF:;BDDCCCACC;ACCC;>AAC??ACC?CACC@C@A::@>AC39>:A:>BA:8>CCCCC>4@<?<>@A:>8<
@ERR101899.4 M10_151:1:2:22312:1325 length=150
GATTTTAACCCGCCATTGTATGTAGAGGCAGAAGTTATTGCTGAAGAATATAACATAATTTCAGAAAGTAGCACATATACATTCGGTCAACCTAAAGAGTTCAAAGAATCAGAATTACGAGAAGAGATTAACAAGCGATTAAACCTAATA
+ERR101899.4 M10_151:1:2:22312:1325 length=150
@@<DFFDBFHHHGG@GHI@DHIH9H@DHFG;BGFDGGEG>@FCFGG@FH@GCHIIGGHFGGGGECA=C7@:DE)?3=CC7@@CEFE=A?C@ACCACA>3:((;>@ACBCCCACC::A@8<9559?B(4>A@3@A?A7@1<?A@#######
@ERR101899.5 M10_151:1:2:15495:1326 length=150
TATCAATGGTTATTATTAACCGTGATTAATTGAAGCAAAACAACTCATTTTCTACTATATGAATAAAAAGAAGTTGGAACACATCATTGCCCCCAACTTCAAAACTCTATTTTCTATTGTTTAGATTTTTACTTTCAGGGTAAAACTGCA
+ERR101899.5 M10_151:1:2:15495:1326 length=150
@<@DFFADFFFHHGI@HIIHDIFCDGGIIFIGG?:EHIIJJIIEGEIGAEGGGFEEHEIIG:CHGHIIIAHGC;)7@@ECEHB@BF@C(66>ADDDD?AC@C>5<CC@C@DCCDDDCDA:CCA@CCDC>C?A>A::>+>8?33>@A>A##`
	WRONG = `ERR101899.5 M10_151:1:2:15495:1326 length=150
TATCAATGGTTATTATTAACCGTGATTAATTGAAGCAAAACAACTCATTTTCTACTATATGAATAAAAAGAAGTTGGAACACATCATTGCCCCCAACTTCAAAACTCTATTTTCTATTGTTTAGATTTTTACTTTCAGGGTAAAACTGCA
ERR101899.5 M10_151:1:2:15495:1326 length=150`
)

func TestReader(t *testing.T) {
	t.Run("correct fastq file can be read", func(t *testing.T) {
		s := strings.NewReader(FASTQ)
		r, err := NewReader(s)
		if err != nil {
			t.Error("Can not create new Reader")
		}
		var b []byte
		var record internal.ReadRaw
		n, err := r.Read(b)
		if n == 0 || err == nil {
			t.Errorf("read %d, error %s, expected record but got %s", n, err, json.Unmarshal(b, &record))
		}
	})
	t.Run("incorrect fastq file can not be read", func(t *testing.T) {
		var b []byte
		var record internal.ReadRaw
		s := strings.NewReader(WRONG)
		r, err := NewReader(s)
		if err != nil {
			t.Error("Can not create new Reader")
		}
		n, err := r.Read(b)
		if n == 0 || err != nil {
			t.Errorf("read %d, error %s, expected record but got %s", n, err, json.Unmarshal(b, &record))
		}
	})
}
